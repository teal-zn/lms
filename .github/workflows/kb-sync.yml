name: Sync Docs → Vertex AI

on:
  workflow_dispatch:
  push:
    paths:
      - '*.md'

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      # 1) ソース取得
      - uses: actions/checkout@v4

      # 2) 認証
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3) gcloud CLI (デフォルトで gsutil も入る)
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          # install_components 行を削除

      # 4) Markdown → GCS
      - name: Copy docs to GCS
        run: |
          gsutil -m rsync -r . gs://${{ secrets.GCS_BUCKET }}/docs

      # 5) GCS → Vertex AI Search
      - name: Import into Vertex AI Search
        run: |
          gcloud discovery-engine data-stores import documents \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --location=global \
            --data-store=${{ secrets.DATASTORE_ID }} \
            --gcs-source=gs://${{ secrets.GCS_BUCKET }}/docs/*.md \
            --auto-generate-ids
